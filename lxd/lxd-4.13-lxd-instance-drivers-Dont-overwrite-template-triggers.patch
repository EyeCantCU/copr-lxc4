From b2a8797af2168acf46b6cb7f4219d26b647625f9 Mon Sep 17 00:00:00 2001
From: Fergus Dall <sidereal@google.com>
Date: Mon, 19 Apr 2021 11:22:49 +1000
Subject: [PATCH] lxd/instance/drivers: Don't overwrite template triggers

Fixes #8674

Signed-off-by: Fergus Dall <sidereal@google.com>
---
 lxd/instance/drivers/driver_common.go | 5 +++++
 1 file changed, 5 insertions(+)

diff --git a/lxd/instance/drivers/driver_common.go b/lxd/instance/drivers/driver_common.go
index 137c625202d..e5d7a1d9cb3 100644
--- a/lxd/instance/drivers/driver_common.go
+++ b/lxd/instance/drivers/driver_common.go
@@ -190,6 +190,11 @@ func (d *common) Backups() ([]backup.InstanceBackup, error) {
 
 // DeferTemplateApply records a template trigger to apply on next instance start.
 func (d *common) DeferTemplateApply(trigger instance.TemplateTrigger) error {
+	// Avoid over-writing triggers that have already been set.
+	if d.localConfig["volatile.apply_template"] != "" {
+		return nil
+	}
+
 	err := d.VolatileSet(map[string]string{"volatile.apply_template": string(trigger)})
 	if err != nil {
 		return errors.Wrap(err, "Failed to set apply_template volatile key")
