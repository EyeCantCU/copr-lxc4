From 195b3c25b87313afb0c0e12c2ee5e06cc83467b6 Mon Sep 17 00:00:00 2001
From: Mark Laing <mark.laing@canonical.com>
Date: Tue, 15 Feb 2022 15:26:30 +0000
Subject: [PATCH] lxd/fsmonitor/drivers: Ignore stale file handle errors.

Signed-off-by: Mark Laing <mark.laing@canonical.com>
---
 lxd/fsmonitor/drivers/driver_fanotify.go | 5 ++++-
 1 file changed, 4 insertions(+), 1 deletion(-)

diff --git a/lxd/fsmonitor/drivers/driver_fanotify.go b/lxd/fsmonitor/drivers/driver_fanotify.go
index 0db60c8fef4..1cc5de30ec0 100644
--- a/lxd/fsmonitor/drivers/driver_fanotify.go
+++ b/lxd/fsmonitor/drivers/driver_fanotify.go
@@ -143,7 +143,10 @@ func (d *fanotify) getEvents(mountFd int) {
 
 		fd, err := unix.OpenByHandleAt(mountFd, fh, 0)
 		if err != nil {
-			d.logger.Error("Failed to open file", log.Ctx{"err": err})
+			errno := err.(unix.Errno)
+			if errno != unix.ESTALE {
+				d.logger.Error("Failed to open file", log.Ctx{"err": err})
+			}
 			continue
 		}
 		unix.CloseOnExec(fd)
