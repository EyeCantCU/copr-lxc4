From 47be53c35209e8f598c96edad34e0abd6f802d85 Mon Sep 17 00:00:00 2001
From: =?UTF-8?q?St=C3=A9phane=20Graber?= <stgraber@ubuntu.com>
Date: Fri, 10 Mar 2023 13:28:59 -0500
Subject: [PATCH] lxd/instance/qemu: Fix SMP on s390x
MIME-Version: 1.0
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 8bit

Closes #11426

Signed-off-by: St√©phane Graber <stgraber@ubuntu.com>
---
 lxd/instance/drivers/driver_qemu.go | 20 +++++++++++++-------
 1 file changed, 13 insertions(+), 7 deletions(-)

diff --git a/lxd/instance/drivers/driver_qemu.go b/lxd/instance/drivers/driver_qemu.go
index 717c4ce85645..508c53ff1e5f 100644
--- a/lxd/instance/drivers/driver_qemu.go
+++ b/lxd/instance/drivers/driver_qemu.go
@@ -7123,13 +7123,19 @@ func (d *qemu) setCPUs(count int) error {
 
 			devID := fmt.Sprintf("cpu%d%d%d", cpu.Props.SocketID, cpu.Props.CoreID, cpu.Props.ThreadID)
 
-			err := monitor.AddDevice(map[string]string{
-				"id":        devID,
-				"driver":    cpu.Type,
-				"socket-id": fmt.Sprintf("%d", cpu.Props.SocketID),
-				"core-id":   fmt.Sprintf("%d", cpu.Props.CoreID),
-				"thread-id": fmt.Sprintf("%d", cpu.Props.ThreadID),
-			})
+			dev := map[string]string{
+				"id":      devID,
+				"driver":  cpu.Type,
+				"core-id": fmt.Sprintf("%d", cpu.Props.CoreID),
+			}
+
+			// No such thing as sockets and threads on s390x.
+			if d.architecture != osarch.ARCH_64BIT_S390_BIG_ENDIAN {
+				dev["socket-id"] = fmt.Sprintf("%d", cpu.Props.SocketID)
+				dev["thread-id"] = fmt.Sprintf("%d", cpu.Props.ThreadID)
+			}
+
+			err := monitor.AddDevice(dev)
 			if err != nil {
 				return fmt.Errorf("Failed to add device: %w", err)
 			}
