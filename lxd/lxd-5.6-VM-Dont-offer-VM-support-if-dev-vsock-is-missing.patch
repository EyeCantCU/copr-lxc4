From 632da4d89ae1f7ecee9057f9c34bbffca3235bda Mon Sep 17 00:00:00 2001
From: Thomas Parrott <thomas.parrott@canonical.com>
Date: Wed, 28 Sep 2022 10:37:00 +0100
Subject: [PATCH] lxd/instance/drivers/driver/qemu: Dont offer VM support if
 /dev/vsock is missing

Fixes #10905

Signed-off-by: Thomas Parrott <thomas.parrott@canonical.com>
---
 lxd/instance/drivers/driver_qemu.go | 5 +++++
 1 file changed, 5 insertions(+)

diff --git a/lxd/instance/drivers/driver_qemu.go b/lxd/instance/drivers/driver_qemu.go
index 9c3a7d7549b7..f17d87b82b11 100644
--- a/lxd/instance/drivers/driver_qemu.go
+++ b/lxd/instance/drivers/driver_qemu.go
@@ -6222,6 +6222,11 @@ func (d *qemu) Info() instance.Info {
 		return data
 	}
 
+	if !shared.PathExists("/dev/vsock") {
+		data.Error = fmt.Errorf("Vsock support is missing (no /dev/vsock)")
+		return data
+	}
+
 	err := util.LoadModule("vhost_vsock")
 	if err != nil {
 		data.Error = fmt.Errorf("vhost_vsock kernel module not loaded")
