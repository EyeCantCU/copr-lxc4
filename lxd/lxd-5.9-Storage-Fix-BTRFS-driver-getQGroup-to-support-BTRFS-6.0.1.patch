From 380d6ce477e59b12a3837a43577ed740b123e934 Mon Sep 17 00:00:00 2001
From: Thomas Parrott <thomas.parrott@canonical.com>
Date: Wed, 4 Jan 2023 09:59:37 +0000
Subject: [PATCH] lxd/storage/drivers/driver/btrfs/utils: Fix getQGroup to
 suport BTRFS >= 6.0.1

Fixes #11210

Signed-off-by: Thomas Parrott <thomas.parrott@canonical.com>
---
 lxd/storage/drivers/driver_btrfs_utils.go | 3 ++-
 1 file changed, 2 insertions(+), 1 deletion(-)

diff --git a/lxd/storage/drivers/driver_btrfs_utils.go b/lxd/storage/drivers/driver_btrfs_utils.go
index 8f0846d2fc9f..e1468e4b1a59 100644
--- a/lxd/storage/drivers/driver_btrfs_utils.go
+++ b/lxd/storage/drivers/driver_btrfs_utils.go
@@ -247,7 +247,8 @@ func (d *btrfs) getQGroup(path string) (string, int64, error) {
 	var qgroup string
 	usage := int64(-1)
 	for _, line := range strings.Split(output, "\n") {
-		if line == "" || strings.HasPrefix(line, "qgroupid") || strings.HasPrefix(line, "---") {
+		// Use case-insensitive field title match because BTRFS tooling changed casing between versions.
+		if line == "" || strings.HasPrefix(strings.ToLower(line), "qgroupid") || strings.HasPrefix(line, "-") {
 			continue
 		}
 
From 35af84276af83bff3523960454c0fa4d3889211a Mon Sep 17 00:00:00 2001
From: Thomas Parrott <thomas.parrott@canonical.com>
Date: Wed, 4 Jan 2023 12:01:17 +0000
Subject: [PATCH] lxd/storage/s3/miniod: Wait for config to be available before
 considering ready

Signed-off-by: Thomas Parrott <thomas.parrott@canonical.com>
---
 lxd/storage/s3/miniod/miniod.go | 2 +-
 1 file changed, 1 insertion(+), 1 deletion(-)

diff --git a/lxd/storage/s3/miniod/miniod.go b/lxd/storage/s3/miniod/miniod.go
index 7af86e9190ec..ee808b573706 100644
--- a/lxd/storage/s3/miniod/miniod.go
+++ b/lxd/storage/s3/miniod/miniod.go
@@ -132,7 +132,7 @@ func (p *Process) WaitReady(ctx context.Context) error {
 	}
 
 	for {
-		_, err = adminClient.ServerInfo(ctx)
+		_, err = adminClient.GetConfig(ctx)
 		if err == nil {
 			return nil
 		}
